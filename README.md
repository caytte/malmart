# 丸Pay (MalPay) - 研究室ミニ購買決済システム

## 概要

「丸Pay」は、研究室内のミニ購買「丸マート」で利用するために開発されたキャッシュレス決済システムです。
Raspberry PiとFeliCa対応の学生証、そしてQRコード経由のWebアプリケーションを利用して、商品の購入、残高のチャージ、利用履歴の確認、入荷リクエストが可能です。

## 開発の背景・目的

本システムは、研究室ミニ購買における以下の課題を解決するために開発されました。

* **現金の不便さの解消:** 「現金がなくて商品が買えない」という状況をなくし、お釣りのやり取りや現金の管理といった煩雑な作業を不要にします。
* **買い出し資金の確保:** 事前にチャージしてもらうことで、商品の買い出し担当者が活動するための資金を安定的に確保しやすくなります。

## 主な機能とメリット

* **キャッシュレス決済:** 研究室への入室に使う学生証(FeliCa)をカードリーダーにかざすだけで、簡単かつ迅速に支払いが完了します。
* **24時間利用可能:** 深夜や休日など、生協やコンビニが閉まっている時間帯でも、いつでも好きな時に買い物ができます。
* **Webアプリ連携:**
    * **オンラインチャージ:** QRコードから専用ページにアクセスし、いつでも残高のチャージ申請ができます。
    * **残高・履歴確認:** 自分の現在の残高や、過去の利用履歴をいつでも確認できます。
    * **入荷リクエスト:** 欲しい商品の入荷リクエストを送ることができます。
* **つけ払い機能:** 手持ちの残高が少し足りなくても、一定額までつけ払い(後払い)が可能です。

## システム構成

このシステムは、店舗に設置された**フロントエンド（Raspberry Pi）**と、Web上で動作する**バックエンド（Google Apps Script）**によって構成されています。

* **フロントエンド (Raspberry Pi)**
    * `tkinter`によるGUIアプリケーションが動作します。
    * NFCカードリーダー(USB接続)でFeliCa学生証のIDm(製造ID)を読み取ります。
    * `mpg321`コマンドを利用して、決済成功・失敗時に音声フィードバックを行います。
    * 決済情報などをバックエンドのGASに送信します。
    * 自動再起動機能(10回の決済ごと)を搭載しており、システムの安定性を保ちます。
* **バックエンド (Google Apps Script)**
    * Webアプリケーションとして動作し、チャージや残高確認ページを提供します。
    * すべてのユーザー情報、残高、決済履歴はGoogleスプレッドシートをデータベースとして記録・管理します。
    * フロントエンドからのリクエストを受け取り、データベースを更新します。
    * 特殊なマーカー文字列(`CaLeNdAr`)を使用してJSONデータを送受信します。

## 技術スタック

* **フロントエンド:**
    * **ハードウェア:** Raspberry Pi + USB接続NFCカードリーダー
    * **言語:** Python 3.x
    * **主要ライブラリ:**
        * `tkinter`: GUI構築
        * `Pillow (PIL)`: 画像処理・GIFアニメーション
        * `nfcpy`: NFCカードリーダー制御 (FeliCa IDm読み取り)
        * `requests`: バックエンドAPIとの通信
        * `pygame.mixer`: サウンド初期化用
        * `schedule`: 定期実行処理
        * `pytz`: タイムゾーン処理(日本時間)
    * **外部コマンド:**
        * `mpg321`: MP3音声再生
* **バックエンド:**
    * **プラットフォーム:** Google Apps Script (GAS)
    * **言語:** JavaScript, HTML
    * **データベース:** Google Sheets

## プロジェクトファイル構成

```
.
├── malpay_combined2.py          # メイン決済アプリケーション
├── IDm_check4registration.py    # 学生証IDm確認用ツール(新規登録時使用)
├── logo_main.gif                # 待機時ロゴアニメーション
├── logo_success.gif             # 決済成功時ロゴアニメーション
├── logo_fail.gif                # 決済失敗時ロゴアニメーション
├── pay.png                      # チャージ用QRコード画像
├── char.png                     # 残高確認用QRコード画像
├── req.png                      # 入荷リクエスト用QRコード画像
├── new_success.mp3              # 決済成功音
├── new_Fail.mp3                 # 決済失敗音
└── README.md                    # 本ドキュメント
```

## 環境構築とセットアップ

このシステムを再構築するための手順です。

### 1. フロントエンド (Raspberry Pi)

1.  **Pythonのインストール:**
    Raspberry PiにPython 3.x がインストールされていることを確認します。

2.  **必要なライブラリのインストール:**
    以下のコマンドを実行し、必要なPythonライブラリをインストールします。

    ```bash
    pip install Pillow nfcpy requests pygame pytz schedule
    ```

3.  **音声再生コマンドのインストール:**
    ```bash
    sudo apt-get install mpg321
    ```

4.  **ソースコードと関連ファイルの配置:**
    このリポジトリの全ファイルをRaspberry Piの任意のディレクトリに配置します。

    必須ファイル:
    * `malpay_combined2.py`
    * `logo_main.gif`, `logo_success.gif`, `logo_fail.gif`
    * `pay.png`, `char.png`, `req.png`
    * `new_success.mp3`, `new_Fail.mp3`

5.  **GAS WebアプリURLの設定:**
    `malpay_combined2.py` の57行目にある `self.app_script_url` を実際のGAS WebアプリURLに変更します。

    ```python
    self.app_script_url = "https://script.google.com/macros/s/YOUR_DEPLOYMENT_ID/exec"
    ```

6.  **ユーザーIDmの登録:**
    * `IDm_check4registration.py` を使用して学生証のIDmを確認します。
    * `malpay_combined2.py` の352-365行目の `user_data` 辞書に新規ユーザー情報を追加します。

    ```python
    user_data = {
        "b'012e5ce6de843949'": ("YOUR_NAME", "EXCELL_CELL_ID(like B1)"),
        # 新規ユーザーを追加...
    }
    ```

7.  **自動起動の設定（推奨）:**
    Raspberry Piの起動時に決済アプリケーションが自動で立ち上がるように設定してください。

### 2. バックエンド (Google Apps Script)

1.  **GASプロジェクトの作成:**
    * Google Driveで新規にGoogleスプレッドシートを作成します。これがデータベースになります。
    * `拡張機能` > `Apps Script` を開き、新しいGASプロジェクトを作成します。

2.  **スプレッドシートの構成:**
    必要なシート・列を作成します(詳細はGASコードを参照)。

3.  **ソースコードのデプロイ:**
    * GASのソースコード（`.gs`ファイル、`.html`ファイル）を、GASエディタに配置します。
    * コード内のスプレッドシートID等を、実際に作成したスプレッドシートのものに書き換えます。

4.  **デプロイ:**
    * `デプロイ` > `新しいデプロイ` を選択します。
    * 種類として「ウェブアプリ」を選択し、以下の設定を行います:
        * **実行ユーザー:** 自分
        * **アクセスできるユーザー:** 全員
    * デプロイして生成されたウェブアプリURLを、フロントエンドのPythonコード(上記手順5)に設定します。

## 使い方

### 利用者（学生）向け

* **商品の購入:**
    1.  購入したい商品を選びます。
    2.  Raspberry Piに接続されたカードリーダーに学生証をかざします。
    3.  画面に「paying...」と表示された後、決済成功の音声が鳴ったら完了です。
    4.  残高が画面に表示されます。

* **チャージ、残高確認、入荷リクエスト:**
    1.  アプリ画面に表示されている対応するQRコードをスマートフォンで読み取ります。
        * 左: チャージ申請ページ
        * 中央: 残高確認ページ
        * 右: 入荷リクエストページ
    2.  表示されたWebページにログインし、各機能を利用します。

### 管理者向け

管理者は、システムの維持管理のために以下のタスクを定期的に行います。

* **ユーザー管理:**
    * データベースとなっているGoogleスプレッドシートを直接編集し、新規ユーザーの登録・管理を行います。
    * 新規ユーザー追加時は、`IDm_check4registration.py` でIDmを確認し、フロントエンドコードとスプレッドシートの両方に登録します。

* **商品リクエストの管理:**
    * 商品の買い出しが完了したら、リクエストページのカウンタをリセットします。

* **会計管理:**
    * チャージ用に集めた現金の総額と、全ユーザーの残高・つけ払い状況を定期的に照合し、全体の資産を管理します。

* **モニタリング:**
    * 画面に表示される決済ログ(最新10件)を確認します。
    * ネットワークステータス(30分ごとに自動チェック)を確認します。
    * 決済失敗が多発する場合や、過度なつけ払いを行っているユーザーがいないかを確認し、必要に応じて対処します。

## システムの動作仕様

### 決済フロー

1. 学生証がNFCリーダーにタッチされる
2. FeliCa IDmを読み取り、登録ユーザーかを確認
3. 画面に「paying...」と表示(オレンジ色)
4. GASバックエンドに決済リクエストを送信(ユーザーコードを含む)
5. バックエンドから残高情報を受信
6. 決済成功/失敗に応じて:
   * 成功: 緑色で「SUCCESS」表示、成功音再生、残高表示
   * 失敗: 赤色で「FAILED」表示、失敗音再生、5秒待機
7. NFCリーダーをクローズ
8. 次の決済待機状態へ

### 自動再起動機能

* 10回の決済処理ごとにシステムを自動再起動
* メモリリークや長時間稼働による不具合を防ぐための措置
* 再起動時は画面に「Restarting System」と表示

### ネットワーク監視

* 30分ごとにGAS WebアプリへのHTTPアクセスでネットワーク状態を確認
* ステータスボックスに「ONLINE」(緑)/「OFFLINE」(赤)を表示

## トラブルシューティング

### NFCリーダーが認識しない
* USBケーブルの接続を確認
* `lsusb` コマンドでデバイスが認識されているか確認
* nfcpyが正しくインストールされているか確認

### 決済が失敗する
* ネットワークステータスが「ONLINE」か確認
* GAS WebアプリのURLが正しく設定されているか確認
* スプレッドシートにユーザーが正しく登録されているか確認
* 残高が不足していないか確認

### 音が鳴らない
* `mpg321` がインストールされているか確認
* 音声ファイル(`.mp3`)が正しいディレクトリに配置されているか確認
* Raspberry Piの音声出力設定を確認

## 利用条件 (License)

本ソフトウェアの利用にあたっては、以下の条件に従ってください。

* **改変:** ソースコードの改変を許可します。
* **再配布:** ソースコードおよび派生物の再配布（二次配布）を禁止します。
* **利用範囲:** 本ソフトウェアの利用は、当研究室内に限定します。

---
This software is provided "as is" without warranty of any kind.

* **Modification:** Permitted.
* **Redistribution:** Prohibited.
* **Scope of Use:** Restricted to use within our laboratory only.
