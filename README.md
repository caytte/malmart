# 丸Pay (MalPay) - 研究室ミニ購買決済システム

## 概要

「丸Pay」は、研究室内のミニ購買「丸マート」で利用するために開発されたキャッシュレス決済システムです。
Raspberry PiとNFC対応の学生証、そしてQRコード経由のWebアプリケーションを利用して、商品の購入、残高のチャージ、利用履歴の確認、入荷リクエストが可能です。

## 開発の背景・目的

本システムは、研究室ミニ購買における以下の課題を解決するために開発されました。

* **現金の不便さの解消:** 「現金がなくて商品が買えない」という状況をなくし、お釣りのやり取りや現金の管理といった煩雑な作業を不要にします。
* **買い出し資金の確保:** 事前にチャージしてもらうことで、商品の買い出し担当者が活動するための資金を安定的に確保しやすくなります。

## 主な機能とメリット

* **キャッシュレス決済:** 研究室への入室に使う学生証をカードリーダーにかざすだけで、簡単かつ迅速に支払いが完了します。
* **24時間利用可能:** 深夜や休日など、生協やコンビニが閉まっている時間帯でも、いつでも好きな時に買い物ができます。
* **Webアプリ連携:**
    * **オンラインチャージ:** QRコードから専用ページにアクセスし、いつでも残高のチャージ申請ができます。
    * **残高・履歴確認:** 自分の現在の残高や、過去の利用履歴をいつでも確認できます。
    * **入荷リクエスト:** 欲しい商品の入荷リクエストを送ることができます。
* **つけ払い機能:** 手持ちの残高が少し足りなくても、一定額までつけ払い（後払い）が可能です。

## システム構成

このシステムは、店舗に設置された**フロントエンド（Raspberry Pi）**と、Web上で動作する**バックエンド（Google Apps Script）**によって構成されています。

* **フロントエンド (Raspberry Pi)**
    * `tkinter`によるGUIアプリケーションが動作します。
    * NFCカードリーダーで学生証のIDを読み取ります。
    * `pygame`を利用して、決済音などの音声フィードバックを行います。
    * 決済情報などをバックエンドのGASに送信します。
* **バックエンド (Google Apps Script)**
    * Webアプリケーションとして動作し、チャージや残高確認ページを提供します。
    * すべてのユーザー情報、残高、決済履歴はGoogleスプレッドシートをデータベースとして記録・管理します。
    * フロントエンドからのリクエストを受け取り、データベースを更新します。

## 技術スタック

* **フロントエンド:**
    * **ハードウェア:** Raspberry Pi
    * **言語:** Python 3.x `（要確認：バージョンを記載してください）`
    * **主要ライブラリ:**
        * `tkinter`: GUI構築
        * `Pillow`: 画像処理
        * `nfcpy`: NFCカードリーダー制御
        * `requests`: バックエンドAPIとの通信
        * `pygame`: サウンド再生
        * `schedule`: 定期実行処理
* **バックエンド:**
    * **プラットフォーム:** Google Apps Script (GAS)
    * **言語:** JavaScript, HTML
    * **データベース:** Google Sheets

## 環境構築とセットアップ

このシステムを再構築するための手順です。

### 1. フロントエンド (Raspberry Pi)

1.  **Pythonのインストール:**
    Raspberry PiにPython `（要確認：バージョンを記載）` がインストールされていることを確認します。

2.  **必要なライブラリのインストール:**
    以下のコマンドを実行し、必要なPythonライブラリをインストールします。

    ```bash
    pip install Pillow schedule nfcpy requests pygame
    ```

3.  **ソースコードの配置:**
    このリポジトリのPython関連ファイルをRaspberry Piの任意のディレクトリに配置します。

4.  **自動起動の設定（推奨）:**
    必要に応じて、Raspberry Piの起動時に決済アプリケーションが自動で立ち上がるように設定してください。

### 2. バックエンド (Google Apps Script)

1.  **GASプロジェクトの作成:**
    * Google Driveで新規にGoogleスプレッドシートを作成します。これがデータベースになります。
    * `拡張機能` > `Apps Script` を開き、新しいGASプロジェクトを作成します。
2.  **ソースコードのデプロイ:**
    * このリポジトリにあるGASのソースコード（`.js`ファイル、`.html`ファイル）を、GASエディタにコピー＆ペーストします。
    * コード内のスプレッドシートIDなどを、実際に作成したスプレッドシートのものに書き換えます。
3.  **デプロイ:**
    * `デプロイ` > `新しいデプロイ` を選択します。
    * 種類として「ウェブアプリ」を選択し、アクセスできるユーザーを「全員」に設定してデプロイします。
    * 生成されたウェブアプリURLを、フロントエンドのPythonコードに設定します。

## 使い方

### 利用者（学生）向け

* **商品の購入:**
    1.  購入したい商品を選びます。
    2.  Raspberry Piに接続されたカードリーダーに学生証をかざします。
    3.  決済成功の音声が鳴ったら完了です。
* **チャージ、残高確認、入荷リクエスト:**
    1.  アプリ画面に表示されているQRコードをスマートフォンで読み取ります。
    2.  表示されたWebページにログインし、各機能を利用します。

### 管理者向け

管理者は、システムの維持管理のために以下のタスクを定期的に行います。

* **ユーザー管理:**
    * データベースとなっているGoogleスプレッドシート (`database.csv`という名前で運用を想定) を直接編集し、新規ユーザーのID、パスワード、初期残高などを設定します。
* **商品リクエストの管理:**
    * 商品の買い出しが完了したら、リクエストページのカウンタをリセットします。
* **会計管理:**
    * チャージ用に集めた現金の総額と、全ユーザーの残高・つけ払い状況を定期的に照合し、全体の資産を管理します。
* **モニタリング:**
    * 決済失敗ログや、過度なつけ払いを行っているユーザーがいないかを確認し、必要に応じて警告を行います。

## 利用条件 (License)

本ソフトウェアの利用にあたっては、以下の条件に従ってください。

* **改変:** ソースコードの改変を許可します。
* **再配布:** ソースコードおよび派生物の再配布（二次配布）を禁止します。
* **利用範囲:** 本ソフトウェアの利用は、当研究室内に限定します。

---
This software is provided "as is" without warranty of any kind.

* **Modification:** Permitted.
* **Redistribution:** Prohibited.
* **Scope of Use:** Restricted to use within our laboratory only.
