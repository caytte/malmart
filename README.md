# 丸Pay (MalPay) - 研究室ミニ購買決済システム

## 概要

「丸Pay」は、研究室内のミニ購買「丸マート」で利用するために開発されたキャッシュレス決済システムです。
Raspberry PiとFeliCa対応の学生証、そしてQRコード経由のWebアプリケーションを利用して、商品の購入（1点110円）、残高のチャージ、利用履歴の確認、入荷リクエストが可能です。

## 開発の背景・目的

本システムは、研究室ミニ購買における以下の課題を解決するために開発されました。

* **現金の不便さの解消:** 「現金がなくて商品が買えない」という状況をなくし、お釣りのやり取りや現金の管理といった煩雑な作業を不要にします。
* **買い出し資金の確保:** 事前にチャージしてもらうことで、商品の買い出し担当者が活動するための資金を安定的に確保しやすくなります。

## 主な機能とメリット

* **キャッシュレス決済:** 研究室への入室に使う学生証(FeliCa)をカードリーダーにかざすだけで、簡単かつ迅速に支払いが完了します。
* **24時間利用可能:** 深夜や休日など、生協やコンビニが閉まっている時間帯でも、いつでも好きな時に買い物ができます。
* **Webアプリ連携:**
    * **オンラインチャージ:** QRコードから専用ページにアクセスし、いつでも残高のチャージ申請ができます。
    * **残高・履歴確認:** 自分の現在の残高や、過去の利用履歴をいつでも確認できます。
    * **入荷リクエスト:** 欲しい商品の入荷リクエストを送ることができます。
* **つけ払い機能:** 手持ちの残高が少し足りなくても、つけ払い(後払い)が可能です。現在は上限を設けていませんが、2000円以上のつけ払いが発生した場合は管理者が個別に対応します。

## システム構成

このシステムは、店舗に設置された**フロントエンド（Raspberry Pi）**と、Web上で動作する**バックエンド（Google Apps Script）**によって構成されています。

### フロントエンド (Raspberry Pi)
* `tkinter`によるGUIアプリケーションが動作します。
* NFCカードリーダー(USB接続)でFeliCa学生証のIDm(製造ID)を読み取ります。
* `mpg321`コマンドを利用して、決済成功・失敗時に音声フィードバックを行います。
* 決済情報などをバックエンドのGASに送信します（`コード.gs`と通信）。
* 自動再起動機能(10回の決済ごと)を搭載しており、システムの安定性を保ちます。
* 30分ごとにネットワークステータスを自動チェックし、接続状態をUI上に表示します。

### バックエンド (Google Apps Script)
バックエンドは複数のGASスクリプトで構成され、それぞれ独立してデプロイされます:

#### **コード.gs** - FeliCa決済処理用（フロントエンドとの連携）
* Raspberry Piからの決済リクエストを処理します。
* セル指定（例: B2）を受け取り、該当セルの残高から110円を減算します。
* 更新後の残高を特殊マーカー文字列(`CaLeNdAr`)で囲んでJSON形式で返します。
* フロントエンドアプリケーションとの通信専用です。

#### **code2.gs** - チャージ・残高確認用
* チャージ申請ページ（`login.html`）を提供します。
* ユーザーID・パスワード認証後、指定金額を残高に加算します。
* 残高照会機能も提供し、現在の残高を表示します。

#### **code3.gs** - QRコード決済用（将来の拡張機能）
* QRコードによる決済ページ（`login.html`を使用）を提供します。
* FeliCaカード決済と同様に、認証後110円を減算します。
* モバイル端末からの決済を想定した機能です。

#### **code.gs** - 商品リクエスト管理用
* 商品入荷リクエストページ（`requests.html`）を提供します。
* ユーザーが「欲しい商品」をリクエストでき、リクエスト数をスプレッドシートに記録します。
* 管理者向けリセット機能（`admin.html`）も含みます。

#### **共通機能**
* すべてのユーザー情報、残高データはGoogleスプレッドシート（`database.csv`相当）で一元管理します。
* `doGet()`メソッドでページルーティングを実現し、HTMLファイルを動的に提供します。

## 技術スタック

* **フロントエンド:**
    * **ハードウェア:** Raspberry Pi + USB接続NFCカードリーダー
    * **言語:** Python 3.x
    * **主要ライブラリ:**
        * `tkinter`: GUI構築
        * `Pillow (PIL)`: 画像処理・GIFアニメーション
        * `nfcpy`: NFCカードリーダー制御 (FeliCa IDm読み取り)
        * `requests`: バックエンドAPIとの通信
        * `pygame.mixer`: サウンド初期化用
        * `schedule`: 定期実行処理
        * `pytz`: タイムゾーン処理(日本時間)
    * **外部コマンド:**
        * `mpg321`: MP3音声再生
* **バックエンド:**
    * **プラットフォーム:** Google Apps Script (GAS)
    * **言語:** JavaScript, HTML, CSS
    * **データベース:** Google Sheets (database.csv相当)
        * **Sheet1**: ユーザー残高管理（A列: ID、B列: 残金）
        * **Sheet2**: 認証情報管理（A列: ID、B列: パスワード、C列: 名前）
        * 商品リクエスト用スプレッドシートは別途存在（リクエスト数を記録）

## プロジェクトファイル構成

```
.
├── main.py                      # メイン決済アプリケーション（Raspberry Pi用）
├── IDm_check4registration.py    # 学生証IDm確認用ツール（新規登録時使用）
│
├── logo_main.gif                # 待機時ロゴアニメーション
├── logo_success.gif             # 決済成功時ロゴアニメーション
├── logo_fail.gif                # 決済失敗時ロゴアニメーション
│
├── pay.png                      # チャージ用QRコード画像
├── char.png                     # 残高確認用QRコード画像
├── req.png                      # 入荷リクエスト用QRコード画像
│
├── new_success.mp3              # 決済成功音
├── new_Fail.mp3                 # 決済失敗音
│
├── コード.gs                    # GAS: FeliCa決済処理（フロントエンド連携用）
├── code.gs                      # GAS: 商品リクエスト管理
├── code2.gs                     # GAS: チャージ・残高確認
├── code3.gs                     # GAS: QRコード決済（将来の拡張機能）
│
├── login.html                   # チャージ・残高確認ページ（code2.gs, code3.gs用）
├── requests.html                # 商品入荷リクエストページ（code.gs用）
├── index.html                   # リクエストページのトップ（code.gs用）
├── links.html                   # 関連リンク集ページ
├── admin.html                   # 管理者用リセットページ（code.gs用）
│
└── README.md                    # 本ドキュメント
```

## 環境構築とセットアップ

このシステムを再構築するための手順です。

### 1. フロントエンド (Raspberry Pi)

1.  **Pythonのインストール:**
    Raspberry PiにPython 3.x がインストールされていることを確認します。

2.  **必要なライブラリのインストール:**
    以下のコマンドを実行し、必要なPythonライブラリをインストールします。

    ```bash
    pip install Pillow nfcpy requests pygame pytz schedule
    ```

3.  **音声再生コマンドのインストール:**
    ```bash
    sudo apt-get install mpg321
    ```

4.  **ソースコードと関連ファイルの配置:**
    このリポジトリのフロントエンド関連ファイルをRaspberry Piの任意のディレクトリに配置します。

    必須ファイル:
    * `main.py`（メインアプリケーション）
    * `IDm_check4registration.py`（ユーザー登録時のみ使用）
    * `logo_main.gif`, `logo_success.gif`, `logo_fail.gif`（GIFアニメーション）
    * `pay.png`, `char.png`, `req.png`（QRコード画像）
    * `new_success.mp3`, `new_Fail.mp3`（効果音）

5.  **GAS WebアプリURLの設定:**
    `main.py` の48行目と246行目にある `self.app_script_url` を実際にデプロイした`コード.gs`のWebアプリURLに変更します。

    ```python
    # 48行目: 決済処理用URL
    self.app_script_url = "https://script.google.com/macros/s/YOUR_GAS_DEPLOYMENT_ID/exec"

    # 246行目: ネットワークステータスチェック用URL
    url = "https://script.google.com/macros/s/YOUR_GAS_DEPLOYMENT_ID/"
    ```

6.  **ユーザーIDmの登録:**
    * `IDm_check4registration.py` を使用して学生証のIDmを確認します:
      ```bash
      python IDm_check4registration.py
      # 学生証をタッチすると、例: b'012e5ce6de843949' のように表示されます
      ```
    * `main.py` の343-345行目の `user_data` 辞書に新規ユーザー情報を追加します:
      ```python
      user_data = {
          "b'012e5ce6de843949'": ("YOUR_NAME", "B2"),  # B2はスプレッドシートの残高セル
          "b'0123456789abcdef'": ("ANOTHER_USER", "B3"),
          # 新規ユーザーを追加...
      }
      ```
    * セル番号はスプレッドシートSheet1のB列と対応させてください（B2, B3, B4...）。

7.  **自動起動の設定（推奨）:**
    Raspberry Piの起動時に決済アプリケーションが自動で立ち上がるように設定してください。

### 2. バックエンド (Google Apps Script)

#### 2-1. スプレッドシートの準備

1.  **残高管理用スプレッドシートの作成:**
    * Google Driveで新規にGoogleスプレッドシートを作成します（名前: `database`など）。
    * **Sheet1**（残高管理）:
        * A1: "ID"、B1: "残金"（ヘッダー行）
        * A2以降: ユーザーID（例: B2, B3, B4...に対応するユーザーコード）
        * B2以降: 各ユーザーの残高（初期値: 0）
    * **Sheet2**（認証情報）:
        * A1: "ID"、B1: "パスワード"、C1: "名前"（ヘッダー行）
        * A2以降: ユーザーID
        * B2以降: パスワード
        * C2以降: ユーザー名

2.  **商品リクエスト用スプレッドシートの作成:**
    * 別のスプレッドシートを作成します（名前: `requests`など）。
    * **Sheet1**:
        * A列: 商品名（例: コアラのマーチ、トッポ、ドリトス...）
        * B列: リクエスト数（初期値: 0）

#### 2-2. GASプロジェクトのデプロイ

各GASスクリプトは**独立してデプロイ**する必要があります。

##### **コード.gs のデプロイ（FeliCa決済処理用）**
1.  残高管理用スプレッドシートから `拡張機能` > `Apps Script` を開きます。
2.  `コード.gs` の内容を貼り付けます。
3.  16行目の決済金額（110円）を確認します。
4.  `デプロイ` > `新しいデプロイ` を選択:
    * 種類: **ウェブアプリ**
    * 実行ユーザー: **自分**
    * アクセスできるユーザー: **全員**
5.  デプロイURLをコピーし、`main.py` の48行目と246行目に設定します。

##### **code2.gs のデプロイ（チャージ・残高確認用）**
1.  新しいGASプロジェクトを作成します。
2.  `code2.gs` と `login.html` をGASエディタに追加します。
3.  14行目、30行目、49行目、65行目のスプレッドシートIDを残高管理用スプレッドシートのIDに書き換えます。
4.  ウェブアプリとしてデプロイし、URLからQRコードを生成して `pay.png` として保存します。

##### **code3.gs のデプロイ（QRコード決済用）**
1.  新しいGASプロジェクトを作成します。
2.  `code3.gs` と `login.html` をGASエディタに追加します。
3.  14行目、30行目、49行目、65行目のスプレッドシートIDを書き換えます。
4.  ウェブアプリとしてデプロイします（将来の拡張機能として準備）。

##### **code.gs のデプロイ（商品リクエスト管理用）**
1.  商品リクエスト用スプレッドシートから `拡張機能` > `Apps Script` を開きます。
2.  `code.gs`、`requests.html`、`index.html`、`links.html`、`admin.html` を追加します。
3.  42行目、64行目、98行目、125行目のスプレッドシートIDを商品リクエスト用スプレッドシートのIDに書き換えます。
4.  ウェブアプリとしてデプロイし、URLからQRコードを生成して `req.png` として保存します。

**重要:** HTMLファイル内の画像URLやGoogleドライブのファイルIDも適宜書き換えてください。

## 使い方

### 利用者（学生）向け

#### 商品の購入（FeliCa決済）
1.  購入したい商品を選びます（**1点110円**）。
2.  Raspberry Piに接続されたカードリーダーに学生証をかざします。
3.  画面に「paying...」（オレンジ色）と表示された後、決済成功音が鳴れば完了です。
4.  決済履歴が画面右側のコンソールに表示され、更新後の残高が確認できます。
5.  残高がマイナスの場合でもつけ払いとして決済は成功します。

#### チャージ・残高確認・入荷リクエスト（QRコード経由）
アプリ画面下部に表示されているQRコードをスマートフォンで読み取ります:

* **左（pay.png）**: チャージ申請ページ
    * ログイン（ID・パスワード入力）
    * チャージ金額を入力して申請
    * 管理者に現金を渡し、残高に反映してもらいます

* **中央（char.png）**: 残高確認ページ
    * ログイン後、現在の残高を確認できます

* **右（req.png）**: 入荷リクエストページ
    * 欲しい商品をリクエストできます
    * リクエスト数が記録され、買い出し時の参考になります

### 管理者向け

管理者は、システムの維持管理のために以下のタスクを定期的に行います。

#### **ユーザー管理**
* **新規ユーザー登録:**
    1.  `IDm_check4registration.py` を実行し、学生証のIDmを取得します。
    2.  残高管理用スプレッドシートに新規ユーザー情報を追加:
        * Sheet1: IDと初期残高（0円）
        * Sheet2: ID、パスワード、氏名
    3.  `main.py` の `user_data` 辞書に、IDmとセル番号のマッピングを追加します。

#### **商品リクエストの管理**
* リクエストページで商品ごとのリクエスト数を確認します。
* 買い出し完了後、管理者ページ（`admin.html`）からリクエストカウンタをリセットします。

#### **会計管理**
* **チャージ処理:**
    1.  学生から現金を受け取ります。
    2.  スプレッドシートの該当ユーザーの残高を手動で加算します。
* **残高・つけ払い監視:**
    * 定期的にスプレッドシートを確認し、マイナス残高が大きいユーザー（目安: -2000円以上）に声をかけます。
    * 現金総額と全ユーザー残高の合計を照合し、会計のバランスを確認します。

#### **システムモニタリング**
* **決済ログ確認:**
    * Raspberry Piの画面右側コンソールに最新10件の決済履歴が表示されます。
    * 決済失敗が多発する場合は、ネットワークやNFCリーダーの状態を確認します。
* **ネットワークステータス:**
    * 画面下部のステータスボックスに「ONLINE」（緑）/「OFFLINE」（赤）が表示されます。
    * 30分ごとに自動チェックされます。
* **システム再起動:**
    * 10回の決済ごとに自動再起動が実行されます（安定性維持のため）。

## システムの動作仕様

### 決済フロー（main.py: 328-394行目）

1. **カード検出**: NFCリーダーが学生証を検出（`nfc.ContactlessFrontend`）
2. **IDm読み取り**: FeliCa IDmを16進数文字列として取得
3. **ユーザー照合**: `user_data`辞書でIDmを検索し、登録ユーザーか確認
4. **処理中表示**: コンソールに「paying...」を追加表示（オレンジ色）
5. **決済リクエスト送信**:
   * GAS（`コード.gs`）にセル番号（例: B2）を含むGETリクエスト送信
   * GASは該当セルから110円を減算し、更新後の残高を返す
6. **レスポンス受信**:
   * マーカー文字列`CaLeNdAr`で囲まれたJSON形式の残高データを抽出
7. **結果表示**:
   * **SUCCESS**: 緑色表示、成功音（`new_success.mp3`）再生、更新後の残高表示
   * **FAILED**: 赤色表示、失敗音（`new_Fail.mp3`）再生、5秒待機
8. **NFCクローズ**: リーダーを閉じて次の決済待機状態へ
9. **カウンタ増加**: 決済回数をカウントし、10回ごとにシステム再起動

### 自動再起動機能（main.py: 20-25行目、382-394行目）

* **トリガー**: 10回の決済処理ごと
* **目的**: メモリリークや長時間稼働による不具合を防止
* **動作**:
    1.  決済カウンタ `j` が10に達したら再起動処理開始
    2.  コンソールに「Restarting System」を表示
    3.  5秒待機後、`os.execv()`で現在のプロセスを再実行
* **効果**: NFCリーダーやGUIの状態をリセットし、安定稼働を維持

### ネットワーク監視（main.py: 231-251行目）

* **頻度**: 30分（1800秒）ごとに自動チェック
* **方法**: GAS WebアプリURL（`コード.gs`）へのHTTP GETリクエスト
* **判定**:
    * レスポンス200: `ONLINE`（緑色表示）
    * タイムアウトまたはエラー: `OFFLINE`（赤色表示）
* **表示**: 画面下部のステータスボックスにリアルタイム反映

### GUIアニメーション（main.py: 78-165行目）

* **待機時**: `logo_main.gif` をループ再生
* **決済時**:
    * 成功時: `logo_success.gif` を1回再生後、待機画面に戻る
    * 失敗時: `logo_fail.gif` を1回再生後、待機画面に戻る
* **実装**: PILの`ImageSequence`でGIFフレームを分解し、tkinterで逐次表示

## トラブルシューティング

### NFCリーダーが認識しない
**症状**: カードをかざしても反応しない

**確認事項**:
1.  USBケーブルの接続を確認
2.  `lsusb` コマンドでNFCリーダーが認識されているか確認
3.  nfcpyが正しくインストールされているか確認: `pip list | grep nfcpy`
4.  権限の問題がないか確認: `sudo` で実行してみる

### 決済が常に失敗する
**症状**: 「FAILED」が表示され、決済が完了しない

**確認事項**:
1.  ネットワークステータスが「ONLINE」（緑）になっているか確認
2.  `main.py` の48行目のGAS URLが正しく設定されているか確認
3.  GAS（`コード.gs`）が正しくデプロイされているか確認
4.  スプレッドシートにユーザーが正しく登録されているか確認:
    * Sheet1のB列に残高が入力されているか
    * `main.py` の `user_data` にIDmとセル番号が正しくマッピングされているか
5.  ブラウザでGAS URLに直接アクセスし、エラーが出ないか確認

### 特定ユーザーだけ決済が失敗する
**原因**: IDmの登録ミスまたはセル番号の不一致

**対処法**:
1.  `IDm_check4registration.py` で正しいIDmを再確認
2.  `main.py` の `user_data` とスプレッドシートのセル番号が一致しているか確認

### 音が鳴らない
**症状**: 決済は成功するが効果音が再生されない

**確認事項**:
1.  `mpg321` がインストールされているか: `which mpg321`
2.  音声ファイルが正しいディレクトリに配置されているか:
    * `new_success.mp3`
    * `new_Fail.mp3`
3.  Raspberry Piの音声出力設定を確認: `raspi-config` → Audio設定
4.  手動で音声を再生してテスト: `mpg321 new_success.mp3`

### GIFアニメーションが表示されない
**症状**: ロゴ画像が表示されない

**確認事項**:
1.  GIFファイルが正しいディレクトリに配置されているか:
    * `logo_main.gif`
    * `logo_success.gif`
    * `logo_fail.gif`
2.  PILライブラリが正しくインストールされているか: `pip list | grep Pillow`

### システムが再起動を繰り返す
**原因**: `os.execv()` による再起動が正常に機能していない

**対処法**:
1.  `main.py` の383行目以降の再起動処理をコメントアウト
2.  手動で再起動するように変更

## 将来的な機能拡張案

* **つけ払い上限の自動制御**: 残高が-2000円以下になったらUI上に警告を表示し、決済を制限する機能
* **QRコード決済の本格運用**: `code3.gs` を活用し、スマートフォンからの決済を可能に
* **決済履歴のデータベース記録**: スプレッドシートに全決済履歴を記録し、統計分析を可能に
* **商品ごとの価格設定**: 現在は一律110円だが、商品マスタを作成して価格を可変に
* **在庫管理機能**: 商品の在庫数を管理し、在庫切れ時に警告を表示
* **自動チャージ**: 銀行振込やキャッシュレス決済サービスとの連携

## セキュリティに関する注意

* **パスワード管理**: スプレッドシートSheet2のパスワードは平文で保存されています。機密性の高い運用の場合はハッシュ化を検討してください。
* **GAS URLの保護**: WebアプリのURLが漏洩すると、誰でもスプレッドシートを操作できる可能性があります。アクセス制限やAPI認証の導入を検討してください。
* **スプレッドシートの権限管理**: データベーススプレッドシートの編集権限は管理者のみに限定してください。
* **Raspberry Piの物理セキュリティ**: 端末への不正アクセスを防ぐため、設置場所を適切に管理してください。

## 開発者情報

* **開発者**: Ito Keito (伊藤啓斗)
* **開発時期**: 2023年〜
* **バージョン**: v3.3 (main.py 31行目に記載)
* **研究室**: H.S.LAB（金沢大学）

## 利用条件 (License)

本ソフトウェアの利用にあたっては、以下の条件に従ってください。

* **改変**: ソースコードの改変を許可します。
* **再配布**: ソースコードおよび派生物の再配布（二次配布）を禁止します。
* **利用範囲**: 本ソフトウェアの利用は、当研究室内に限定します。
* **免責事項**: 本ソフトウェアは「現状のまま」提供され、いかなる保証もありません。

---

This software is provided "as is" without warranty of any kind.

* **Modification**: Permitted.
* **Redistribution**: Prohibited.
* **Scope of Use**: Restricted to use within our laboratory only.
* **Copyright**: © Ito Keito. Some Rights Reserved.
